@using MoodBite.Models.RecipeViewModel

@model RecipeDetailViewModel
@{
    Layout = "~/Views/Shared/_StandardLayout.cshtml";
    string chosenMood = (string)Session["ChosenMood"];
    string iconName = "";

    var containsAllergens = new List<string>();
    var user = Session["User"] as User;

    switch (chosenMood?.ToLower())
    {
        case "happy":
            iconName = "far fa-smile";
            break;
        case "sad":
            iconName = "far fa-sad-tear";
            break;
        case "angry":
            iconName = "far fa-angry";
            break;
        case "disgusted":
            iconName = "far fa-grimace";
            break;
        case "fearful":
            iconName = "far fa-flushed";
            break;
        case "surprised":
            iconName = "far fa-surprise";
            break;
        case "euthymia":
            iconName = "far fa-grin";
            break;
    }

    var recipe = Model.recipeImagesReadMore;
    ViewBag.Title = $"{recipe.RecipeName}";
    //ViewBag.TitleHeader = $"{recipe.RecipeName}";
    //ViewBag.TitleSubheader = $"{recipe.RecipeName}";

    // Default MIME type
    //string mimeType = "image/jpeg";
    //if (recipe.ImageURL != null && recipe.ImageURL.Length > 0)
    //{
    //    // Determine the MIME type based on the first few bytes of the image data
    //    byte[] imageData = recipe.ImageURL;
    //    string firstBytes = System.Text.Encoding.UTF8.GetString(imageData.Take(4).ToArray());

    //    if (firstBytes.StartsWith("GIF8"))
    //    {
    //        mimeType = "image/gif";
    //    }
    //    else if (firstBytes.StartsWith("\xFF\xD8"))
    //    {
    //        mimeType = "image/jpeg";
    //    }
    //    else if (firstBytes.StartsWith("\x89PNG\x0D\x0A\x1A\x0A"))
    //    {
    //        mimeType = "image/png";
    //    }
    //}
    var ingredientName = new List<string>();
    var ingredientQty = new List<int>();
    var ingredientUnit = new List<string>();
    var allergens = string.Empty;

    foreach (var recipeIngredient in Model.recipeIngredientsReadMore)
    {
        ingredientName.Add(recipeIngredient.IngredientName);
        ingredientQty.Add(Convert.ToInt32(recipeIngredient.Quantity));
        ingredientUnit.Add(recipeIngredient.Unit);
        if (Model.allergy.Select(model => model.ToLower()).Contains(recipeIngredient.IngredientName.ToLower()))
        {
            containsAllergens.Add(recipeIngredient.IngredientName);
        }
        allergens = string.Join(", ", containsAllergens);
    }
}

<!-- Favicon -->
<link href="~/Content/MainTemplate/img/favicon.ico" rel="icon">

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400|Nunito:600,700" rel="stylesheet">

<!-- CSS Libraries -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
<link href="~/Content/MainTemplate/lib/animate/animate.min.css" rel="stylesheet">
<link href="~/Content/MainTemplate/lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
<link href="~/Content/MainTemplate/lib/flaticon/font/flaticon.css" rel="stylesheet">
<link href="~/Content/MainTemplate/lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"/>

<!-- Template Stylesheet -->
<link href="~/Content/MainTemplate/css/style.css" rel="stylesheet">

<div class="row">
    <div class="col-lg-8">
        <div class="single-content recipecontent">
            @*<img src="data:@($"data:{mimeType};base64,{Convert.ToBase64String(recipe.ImageURL)}")" style="width:730px; height: 550px;"/>*@
            @if (!string.IsNullOrEmpty(recipe.ImagePath))
            {
                <img src="@Url.Content(recipe.ImagePath)" style="width:730px; height: 550px;" />
            }
            else
            {
                <img src="https://placehold.co/730x550" style="width:730px; height: 550px;" />
            }
            <div style="display:flex; justify-content:space-between; align-items:center">
                <div>
                    <h6 class="inline-block">This recipe contains: </h6>
                    <span><i>@allergens</i></span>
                    <h2 style="display:block">@recipe.RecipeName</h2>
                </div>
                <div class="stars">
                    <form action="">
                        <input class="star star-5" id="star-5" type="radio" name="star" value="5"/>
                        <label class="star star-5" for="star-5"></label>
                        <input class="star star-4" id="star-4" type="radio" name="star" value="4"/>
                        <label class="star star-4" for="star-4"></label>
                        <input class="star star-3" id="star-3" type="radio" name="star" value="3"/>
                        <label class="star star-3" for="star-3"></label>
                        <input class="star star-2" id="star-2" type="radio" name="star" value="2"/>
                        <label class="star star-2" for="star-2"></label>
                        <input class="star star-1" id="star-1" type="radio" name="star" value="1"/>
                        <label class="star star-1" for="star-1"></label>
                    </form>
                </div>
            </div>
            <p>
                @Model.recipeDetailsWithoutIngredientsReadMore.RecipeDescription
            </p>
            <div style="margin:0;padding:0;" class="row">
                <div class="col-md-6"  style="margin:0;padding:0;">
                    <h4>Preparation Time</h4>
                    <p>
                        @Model.recipeDetailsWithoutIngredientsReadMore.PreparationTime
                    </p>
                </div>
                <div class="col-md-6"  style="margin:0; padding:0;">
                    <h4>Cooking Duration</h4>
                    <p>
                        @Model.recipeDetailsWithoutIngredientsReadMore.CookingDuration
                </p>
            </div>
            </div>
            <h4>Ingredients</h4>
            <div class="form-check row" style="margin-bottom:1rem; padding:0 1rem 0 0; width:max-content;">
                <table>
                    <tbody>
                        @for (int i = 0; i < Model.recipeIngredientsReadMore.Count(); i++)
            {
                            <tr>
                                <td class="ingredient-qty " style="padding:0 0 0 1rem !important; text-align:right;">@ingredientQty.ElementAt(i)</td>
                                <td class="ingredient-unit" style="padding:0 0 0 1rem !important; text-align:left;">@ingredientUnit.ElementAt(i)</td>
                                <td class="ingredient-name" style="padding:0 0 0 1rem !important; text-align:left;">@ingredientName.ElementAt(i)</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div style="margin:0 0 1rem">
                <h4 style="display:inline-block; margin-right:1rem">Cooking Instruction</h4>
                <i class="fas fa-microphone"></i>
                @{
                    var cookingInstruction = Model.recipeDetailsWithoutIngredientsReadMore.CookingInstruction as string;
                    string[] steps = cookingInstruction.Split(new string[] { "./ " }, StringSplitOptions.RemoveEmptyEntries);

                    foreach (var step in steps)
                    {
                        <p>@step</p>
                    }
                }
            </div>
                @{
                    containsAllergens.Clear();
                    ingredientName.Clear();
                    ingredientQty.Clear();
                    ingredientUnit.Clear();
                }
            <div style="margin:0 0 1rem">
                <h4>Rating</h4>
                @{
                    double recipeRating = 0;
                    int totalReviews = 0;
                    foreach (var recipesRating in Model.recipeDetailsWithRating)
                    {
                        if (recipesRating.RecipeID == Model.recipeDetailsWithoutIngredientsReadMore.RecipeID)
                        {
                            recipeRating = Convert.ToDouble(recipesRating.Rating);
                            totalReviews = Convert.ToInt32(recipesRating.TotalReview);
                        }
                    }
                }
                <h6>@recipeRating<i class="far fa-star"> (@totalReviews Reviews)</i></h6>

            </div>
            <div class="blog-text recipe-readmore-btn">
                <button class="btn custom-btn" href="#">Download Recipe</button>

                @if (Model.userPremium != null && Model.foodSaleView != null)
                {
                    if(Model.foodSaleView.Available == true)
                    {
                        <button class="btn custom-btn addToCartBtn" style="background-color:red">Add to cart</button>
                    }
                    else
                    {
                        <button class="btn custom-btn addToCartBtn disable-button" style="background-color:red" disabled>Add to cart (Not available)</button>
                    }
                }
                else
                {
                    <button class="btn custom-btn disable-button" style="background-color:red; display:none;" href="#" disabled>Add to cart</button>
                }
            </div>
        </div>
        @*<div class="single-tags">
            <a href="">National</a>
            <a href="">International</a>
            <a href="">Economics</a>
            <a href="">Politics</a>
            <a href="">Lifestyle</a>
            <a href="">Technology</a>
            <a href="">Trades</a>
        </div>*@
        <div class="single-bio">
            <div class="single-bio-img">
                @*@{ 
                    if (Model.uploadersProfilePic.ProfilePicture != null && Model.uploadersProfilePic.ProfilePicture.Length > 0)
                    {
                        // Determine the MIME type based on the first few bytes of the image data
                        byte[] imageData = Model.uploadersProfilePic.ProfilePicture;
                        string firstBytes = System.Text.Encoding.UTF8.GetString(imageData.Take(4).ToArray());

                        if (firstBytes.StartsWith("GIF8"))
                        {
                            mimeType = "image/gif";
                        }
                        else if (firstBytes.StartsWith("\xFF\xD8"))
                        {
                            mimeType = "image/jpeg";
                        }
                        else if (firstBytes.StartsWith("\x89PNG\x0D\x0A\x1A\x0A"))
                        {
                            mimeType = "image/png";
                        }
                    }
                }*@
                @if (string.IsNullOrEmpty(Model.uploadersProfilePic.ProfilePicturePath))
                {
                    <img src="~/Content/UsersProfileImages/noprofile-boy.png" />
                }
                else
                {
                    <img src="@Url.Content(Model.uploadersProfilePic.ProfilePicturePath)" />
                }
            </div>
            <div class="single-bio-text">
                <h3>Uploaders Info</h3>
                <div>
                    @{ 
                        string uploadersName = string.Empty;
                        int totalUploads = 0;
                        string highestRatedRecipeName = string.Empty;
                        double highestRatedRecipeRate = 0;
                        int totalReview = 0;
                        DateTime dateJoined = new DateTime();
                        List<vw_recipeUploadersNameWithRating> listOfRecipe = new List<vw_recipeUploadersNameWithRating>();

                        foreach (var x in Model.recipeUploadersNameWithRatingReadMore)
                        {
                            if(x.UploadedBy == recipe.Uploaded_by)
                            {
                                listOfRecipe.Add(x);
                            }
                            if (x.RecipeName == Model.recipeReadMore.RecipeName)
                            {
                                uploadersName = Convert.ToString(x.UploadedBy);
                                foreach (var y in Model.userUploadCounts)
                                {
                                    if (y.userID == x.userID)
                                    {
                                        totalUploads = Convert.ToInt32(y.TotalUpload);
                                    }
                                }
                            }
                        }
                        foreach (var item in listOfRecipe)
                        {
                            if (item.Rating >= highestRatedRecipeRate)
                            {
                                highestRatedRecipeRate = Convert.ToDouble(item.Rating);
                                highestRatedRecipeName = Convert.ToString(item.RecipeName);
                                totalReview = Convert.ToInt32(item.TotalReview);
                                dateJoined = Convert.ToDateTime(item.DateCreated);
                            }
                        }
                    }
                    <h6 class="inline-block">Name: </h6> <span>@uploadersName</span>
                </div>
                <div>
                    <h6 class="inline-block">Total Uploads: </h6> <span>@totalUploads</span>
                </div>
                <div>
                    <h6 class="inline-block">Highest rated recipe: </h6> <span>@highestRatedRecipeName @highestRatedRecipeRate<i class="far fa-star"> (@totalReview Reviews)</i></span>
                </div>
                <div>
                    <h6 class="inline-block">Date joined: </h6> <span>@dateJoined.ToShortDateString()</span>
                </div>
            </div>
        </div>

        @* back next buttons *@
        <div>
            @*<div class="single-related">
            <div class="owl-carousel related-slider">
                <div class="owl-nav" >
                    <div class="owl-prev">
                        <a><i class="fa fa-angle-left" aria-hidden="true"></i></a>
                    </div>
                    <div class="owl-next disabled">
                        <a><i class="fa fa-angle-right" aria-hidden="true"></i></a>
                    </div>
                </div>
                <div class="post-item">
                    <div class="post-img">
                        <img src="~/Content/MainTemplate/img/post-1.jpg" />
                    </div>
                    <div class="post-text">
                        <a href="">Lorem ipsum dolor sit amet consec adipis elit</a>
                        <div class="post-meta">
                            <p>By<a href="">Admin</a></p>
                            <p>In<a href="">Web Design</a></p>
                        </div>
                    </div>
                </div>
                <div class="post-item">
                    <div class="post-img">
                        <img src="~/Content/MainTemplate/img/post-2.jpg" />
                    </div>
                    <div class="post-text">
                        <a href="">Lorem ipsum dolor sit amet consec adipis elit</a>
                        <div class="post-meta">
                            <p>By<a href="">Admin</a></p>
                            <p>In<a href="">Web Design</a></p>
                        </div>
                    </div>
                </div>
                <div class="post-item">
                    <div class="post-img">
                        <img src="~/Content/MainTemplate/img/post-3.jpg" />
                    </div>
                    <div class="post-text">
                        <a href="">Lorem ipsum dolor sit amet consec adipis elit</a>
                        <div class="post-meta">
                            <p>By<a href="">Admin</a></p>
                            <p>In<a href="">Web Design</a></p>
                        </div>
                    </div>
                </div>
                <div class="post-item">
                    <div class="post-img">
                        <img src="~/Content/MainTemplate/img/post-4.jpg" />
                    </div>
                    <div class="post-text">
                        <a href="">Lorem ipsum dolor sit amet consec adipis elit</a>
                        <div class="post-meta">
                            <p>By<a href="">Admin</a></p>
                            <p>In<a href="">Web Design</a></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>*@
        </div>

        @* comment section *@
        <div>
            @*<div class="single-comment">
            <h2>3 Comments</h2>
            <ul class="comment-list">
                <li class="comment-item">
                    <div class="comment-body">
                        <div class="comment-img">
                            <img src="~/Content/MainTemplate/img/user.jpg" />
                        </div>
                        <div class="comment-text">
                            <h3><a href="">Josh Dunn</a></h3>
                            <span>01 Jan 2045 at 12:00pm</span>
                            <p>
                                Lorem ipsum dolor sit amet elit. Integer lorem augue purus mollis sapien, non eros leo in nunc. Donec a nulla vel turpis tempor ac vel justo. In hac platea dictumst.
                            </p>
                            <a class="btn" href="">Reply</a>
                        </div>
                    </div>
                </li>
                <li class="comment-item">
                    <div class="comment-body">
                        <div class="comment-img">
                            <img src="~/Content/MainTemplate/img/user.jpg" />
                        </div>
                        <div class="comment-text">
                            <h3><a href="">Josh Dunn</a></h3>
                            <p><span>01 Jan 2045 at 12:00pm</span></p>
                            <p>
                                Lorem ipsum dolor sit amet elit. Integer lorem augue purus mollis sapien, non eros leo in nunc. Donec a nulla vel turpis tempor ac vel justo. In hac platea dictumst.
                            </p>
                            <a class="btn" href="">Reply</a>
                        </div>
                    </div>
                    <ul class="comment-child">
                        <li class="comment-item">
                            <div class="comment-body">
                                <div class="comment-img">
                                    <img src="~/Content/MainTemplate/img/user.jpg" />
                                </div>
                                <div class="comment-text">
                                    <h3><a href="">Josh Dunn</a></h3>
                                    <p><span>01 Jan 2045 at 12:00pm</span></p>
                                    <p>
                                        Lorem ipsum dolor sit amet elit. Integer lorem augue purus mollis sapien, non eros leo in nunc. Donec a nulla vel turpis tempor ac vel justo. In hac platea dictumst.
                                    </p>
                                    <a class="btn" href="">Reply</a>
                                </div>
                            </div>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
        <div class="comment-form">
            <h2>Leave a comment</h2>
            <form>
                <div class="form-group">
                    <label for="name">Name *</label>
                    <input type="text" class="form-control" id="name">
                </div>
                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" class="form-control" id="email">
                </div>
                <div class="form-group">
                    <label for="website">Website</label>
                    <input type="url" class="form-control" id="website">
                </div>

                <div class="form-group">
                    <label for="message">Message *</label>
                    <textarea id="message" cols="30" rows="5" class="form-control"></textarea>
                </div>
                <div class="form-group">
                    <input type="submit" value="Post Comment" class="btn custom-btn">
                </div>
            </form>
        </div>*@
        </div>
        
    </div>

    <div class="col-lg-4">
        <div class="sidebar">

            <div class="sidebar-widget">
                <h2 class="widget-title">Similar Recipes</h2>
                <div class="recent-post">
                    @if (ViewBag.NoRecipesWithSimilarMoodTagMsg == null)
                    {
                        foreach (var recom in Model.recommendedRecipes)
                        {
                            //// Default MIME type
                            //if (recom.ImageURL != null && recom.ImageURL.Length > 0)
                            //{
                            //    // Determine the MIME type based on the first few bytes of the image data
                            //    byte[] imageData = recom.ImageURL;
                            //    string firstBytes = System.Text.Encoding.UTF8.GetString(imageData.Take(4).ToArray());

                            //    if (firstBytes.StartsWith("GIF8"))
                            //    {
                            //        mimeType = "image/gif";
                            //    }
                            //    else if (firstBytes.StartsWith("\xFF\xD8"))
                            //    {
                            //        mimeType = "image/jpeg";
                            //    }
                            //    else if (firstBytes.StartsWith("\x89PNG\x0D\x0A\x1A\x0A"))
                            //    {
                            //        mimeType = "image/png";
                            //    }
                            //}
                            <div class="post-item">
                                <div class="post-img">
                                    <img src="@Url.Content(recom.ImagePath)" />
                                </div>
                                <div class="post-text">
                                    <a href="">@recom.RecipeName</a>
                                    <div class="post-meta">
                                        <p>By<a href="">@recom.Uploaded_by</a></p>
                                        <p><a href=""><i class="@iconName"></i></a></p>
                                    </div>
                                </div>
                            </div>
                        }
                    } else
                    {
                        <i>@ViewBag.NoRecipesWithSimilarMoodTagMsg</i>
                    }

                </div>
            </div>

            @*<div class="sidebar-widget">
                <div class="image-widget">
                    <a href="#"><img src="~/Content/MainTemplate/img/blog-1.jpg" alt="Image"></a>
                </div>
            </div>*@

            <div class="sidebar-widget">
                <h2 class="widget-title">Categories</h2>
                <div class="category-widget">
                    <ul>
                        @foreach (var foodCategory in Model.foodCategories)
                        {
                            var recipeCount = 0;
                            foreach (var recipeWithCategoryName in Model.allRecipeWithFoodCategoryName)
                            {
                                if (foodCategory.ToLower() == recipeWithCategoryName.FoodCategoryName.ToLower())
                                {
                                    recipeCount++;
                                }
                            }
                            <li><a href="">@foodCategory</a><span>(@recipeCount)</span></li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- JavaScript Libraries -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
<script src="~/Content/MainTemplate/lib/easing/easing.min.js"></script>
<script src="~/Content/MainTemplate/lib/owlcarousel/owl.carousel.min.js"></script>
<script src="~/Content/MainTemplate/lib/tempusdominus/js/moment.min.js"></script>
<script src="~/Content/MainTemplate/lib/tempusdominus/js/moment-timezone.min.js"></script>
<script src="~/Content/MainTemplate/lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>

<!-- Contact Javascript File -->
<script src="~/Content/MainTemplate/mail/jqBootstrapValidation.min.js"></script>
<script src="~/Content/MainTemplate/mail/contact.js"></script>

<!-- Template Javascript -->
<script src="~/Content/MainTemplate/js/main.js"></script>

<script>
    $("input[name='star']").change(function () {
        var rating = parseInt($("input[name='star']:checked").val(), 10);
        var recipeID = parseInt(@recipe.RecipeID);

        var data = {
            rating: rating,
            recipeID: recipeID
        };

        $.ajax({
            url: "/UsersPage/SubmitRating",
            type: "POST",
            data: data,
            success: function (response) {
                if (response.success) {
                    alert(response.message);
                } else {
                    alert(response.message);
                }
            },
            error: function () {
                alert("An error occurred while submitting the rating.");
            }
        });
    });

    $("button.addToCartBtn").click(function () {
        // Disable the button to prevent multiple clicks
        $(this).prop("disabled", true);

        var recipeID = parseInt(@recipe.RecipeID);
        var userID = parseInt(@user.userID);

        var data = {
            recipeID: recipeID
        };

        $.ajax({
            url: "/UsersPage/AddToCart",
            type: "POST",
            data: data,
            success: function (response) {
                if (response.success) {
                    alert(response.message);
                } else {
                    alert(response.message);
                }
            },
            error: function () {
                alert("An error occurred while adding the product to the cart.");
            },
            complete: function () {
                // Re-enable the button after the request is complete
                $("button.custom-btn").prop("disabled", false);
            }
        });
    });

</script>
